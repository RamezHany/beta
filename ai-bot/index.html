<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helal AI | مساعد التسويق الذكي</title>
    <meta name="description" content="مساعد التسويق الذكي من وكالة هلال - خبير في التسويق الرقمي، التسويق بالمحتوى، وسائل التواصل الاجتماعي، والإعلانات">
    <link rel="icon" type="image/x-icon" href="../assets/img/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Set the workerSrc for pdf.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js`;
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/unified-style.css">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        }
        
        /* Helal Brand Colors */
        :root {
            --helal-gold: #FFD700;
            --helal-gold-dark: #E6A800; /* تعديل اللون الذهبي الداكن ليكون أقل حدة */
            --helal-bg-dark: #1a1a1a;
            --helal-bg-secondary: #2d2d2d;
            --helal-card-bg: rgba(255, 255, 255, 0.05);
            --helal-border: rgba(255, 215, 0, 0.15); /* تقليل شفافية الحدود */
        }
        
        #chat-container::-webkit-scrollbar {
            width: 8px;
        }
        .dark #chat-container::-webkit-scrollbar-track {
            background: var(--helal-bg-dark);
        }
        .dark #chat-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--helal-gold), var(--helal-gold-dark));
            border-radius: 8px;
            border: 2px solid var(--helal-bg-dark);
            opacity: 0.8;
        }
        
        /* Helal Brand Styling */
        .helal-gradient {
            background: linear-gradient(135deg, var(--helal-gold), var(--helal-gold-dark));
            opacity: 0.9; /* تقليل حدة التدرج اللوني */
        }
        
        .helal-card {
            background: var(--helal-card-bg);
            border: 2px solid var(--helal-border);
            backdrop-filter: blur(15px);
        }
        
        /* Improve readability: disable blur on main container and input */
        .chat-fixed-container.helal-card {
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
        }
        #message-input.helal-card {
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            background: rgba(0, 0, 0, 0.5);
        }
        
        /* Fully disable any remaining blur globally */
        .backdrop-blur-sm {
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
        }
        .helal-card {
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
        }
        
        .helal-glow {
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
            /* Override global glow blur from unified-style.css */
            filter: none !important;
        }
        
        /* Background Pattern */
        .bg-pattern::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('../assets/v3.svg') center/cover;
            opacity: 0.1;
            pointer-events: none;
            z-index: 0;
        }
        
        /* Logo animation */
        .logo-animate {
            animation: logoGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes logoGlow {
            from {
                filter: drop-shadow(0 0 5px var(--helal-gold));
            }
            to {
                filter: drop-shadow(0 0 15px var(--helal-gold));
            }
        }
        
        /* Mobile Responsive Improvements */
        @media (max-width: 768px) {
            .max-w-xs {
                max-width: 85% !important;
            }
            
            .md\\:max-w-md {
                max-width: 90% !important;
            }
            
            /* Adjust message containers for mobile */
            .mobile-message {
                max-width: 100%;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            /* Header adjustments */
            .mobile-header {
                flex-direction: column;
                text-align: center;
                gap: 8px;
            }
            
            .mobile-header .logo-section {
                justify-content: center;
            }
            
            .mobile-header .powered-by {
                font-size: 10px;
                opacity: 0.7;
            }
            
            /* Chat input improvements */
            .mobile-input {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 12px;
            }
            
            /* Typing indicator */
            .mobile-typing {
                max-width: 80%;
            }
            
            /* File preview adjustments */
            .mobile-file-preview {
                max-width: 90%;
                overflow: hidden;
            }
        }
        
        @media (max-width: 480px) {
            /* Extra small devices */
            .container-mobile {
                margin: 10px;
                max-width: calc(100vw - 20px);
                height: calc(100vh - 20px);
            }
            
            .text-mobile-sm {
                font-size: 14px;
            }
            
            .p-mobile {
                padding: 12px;
            }
            
            /* Avatar sizes for mobile */
            .avatar-mobile {
                width: 32px;
                height: 32px;
                padding: 6px;
            }
            
            /* Button sizes for mobile */
            .btn-mobile {
                padding: 10px;
                min-width: 44px; /* Minimum touch target */
                min-height: 44px;
            }
        }
        
        /* Touch-friendly improvements */
        .touch-target {
            min-width: 44px;
            min-height: 44px;
        }
        
        /* Prevent horizontal scroll */
        body {
            overflow-x: hidden;
        }
        
        /* iOS Safari viewport height fix */
        .full-height {
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
        }
        
        /* Fixed chat container */
        .chat-fixed-container {
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            max-height: 100vh;
            max-height: calc(var(--vh, 1vh) * 100);
            overflow: hidden;
        }
        
        @media (min-width: 768px) {
            .chat-fixed-container {
                height: 90vh;
                max-height: 90vh;
            }
        }
        
        .chat-messages-area {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 1rem 1.5rem;
            scrollbar-width: thin;
            scrollbar-color: var(--helal-gold) rgba(0, 0, 0, 0.3);
        }
        
        .chat-messages-area::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages-area::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
        }
        
        .chat-messages-area::-webkit-scrollbar-thumb {
            background: var(--helal-gold);
            border-radius: 3px;
        }
        
        .chat-messages-area::-webkit-scrollbar-thumb:hover {
            background: var(--helal-gold-dark);
        }
        
        @media (max-width: 768px) {
            .chat-messages-area {
                padding: 0.75rem 1rem;
            }
            
            .chat-messages-area::-webkit-scrollbar {
                width: 4px;
            }
        }
        
        /* Improve readability on mobile */
        @media (max-width: 768px) {
            .text-mobile-readable {
                line-height: 1.6;
                font-size: 16px;
            }
            
            /* Better font sizes for mobile */
            body {
                font-size: 16px;
            }
            
            /* Prevent zoom on input focus iOS */
            input[type="text"],
            input[type="email"],
            textarea {
                font-size: 16px !important;
            }
        }
        
        /* Copy button styles */
        .copy-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .message-container:hover .copy-btn {
            opacity: 1;
        }
        
        @media (max-width: 768px) {
            .copy-btn {
                opacity: 0.7;
            }
        }
        
        /* Share button styles */
        .share-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .message-container:hover .share-btn {
            opacity: 1;
        }
        
        @media (max-width: 768px) {
            .share-btn {
                opacity: 0.7;
            }
        }
        
        /* Content Calendar Canvas Styles */
        .calendar-canvas {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
        }
        
        .calendar-cell {
            min-height: 80px;
            transition: all 0.3s ease;
        }
        
        .calendar-cell:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: var(--helal-gold);
        }
        
        .editable-cell {
            outline: none;
            cursor: text;
        }
        
        .editable-cell:focus {
            background: rgba(255, 215, 0, 0.15);
            border-color: var(--helal-gold);
        }
        
        .canvas-toolbar {
            position: sticky;
            top: 0;
            z-index: 10;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
        }
        
        /* Markdown tables in chat */
        .markdown-table {
            font-size: 14px;
            min-width: 300px;
        }
        
        .markdown-table th {
            font-weight: bold;
            text-align: center;
        }
        
        .markdown-table td {
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .markdown-table {
                font-size: 12px;
            }
            
            .markdown-table th,
            .markdown-table td {
                padding: 8px !important;
            }
        }
    </style>
</head>
<body class="bg-pattern relative min-h-screen flex items-center justify-center p-2 sm:p-4">

    <div class="flex flex-col w-full  helal-card rounded-2xl sm:rounded-3xl helal-glow relative z-10 container-mobile chat-fixed-container">
        <!-- Header -->
        <header class="helal-gradient text-black p-4 sm:p-6 rounded-t-2xl sm:rounded-t-3xl shadow-lg flex-shrink-0 relative mobile-header">
            <div class="flex items-center justify-between gap-3 sm:gap-4">
                <div class="flex items-center gap-3 sm:gap-4 logo-section">
                    <!-- Helal Logo -->
                    <div class="logo-animate">
                        <img src="../assets/img/logo/logo-white.png" alt="Helal Logo" class="w-8 h-10 sm:w-10 sm:h-12 object-contain filter brightness-0">
                    </div>
                    <div class="flex-1 min-w-0">
                        <h1 class="text-lg sm:text-xl md:text-2xl font-bold truncate">Helal AI</h1>
                        <p class="text-xs sm:text-sm opacity-90">مساعد التسويق الذكي</p>
                    </div>
                </div>
                <!-- Action Buttons -->
                <div class="flex gap-2">
                    <button id="canvas-btn" class="bg-black/20 hover:bg-black/30 text-black px-3 py-2 rounded-lg text-xs sm:text-sm font-semibold transition-all flex items-center gap-1 sm:gap-2" title="كانفس المحتوى">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        <span class="hidden sm:inline">كانفس</span>
                    </button>
                <button id="new-chat-btn" class="bg-black/20 hover:bg-black/30 text-black px-3 py-2 rounded-lg text-xs sm:text-sm font-semibold transition-all flex items-center gap-1 sm:gap-2" title="بداية جديدة">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    <span class="hidden sm:inline">جديد</span>
                </button>
                </div>
            </div>
            <!-- <div class="text-center sm:text-right text-xs powered-by mt-2 sm:mt-0">
                <p class="text-xs">Powered by</p>
                <p class="font-bold text-xs sm:text-sm">Helal Content Marketing</p>
            </div> -->
        </header>

        <!-- Chat Container -->
        <main class="chat-messages-area relative" style="background: rgba(0, 0, 0, 0.4);" id="chat-container">
            <div id="placeholder" class="absolute inset-0 flex items-center justify-center p-4">
                <div class="text-center text-gray-300 max-w-sm">
                    <div class="helal-gradient w-16 h-16 sm:w-20 sm:h-20 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-black sm:w-10 sm:h-10">
                            <path d="M21 15V6"/>
                            <path d="M18.5 18a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"/>
                            <path d="M12 12H3"/>
                            <path d="M16 6H3"/>
                            <path d="M12 18H3"/>
                        </svg>
                    </div>
                    <h3 class="text-lg sm:text-xl font-bold text-yellow-400 mb-2 text-mobile-readable">مرحباً بك في Helal AI</h3>
                    <p class="text-gray-400 text-sm sm:text-base text-mobile-readable">مساعدك الذكي المتخصص في التسويق بالمحتوى</p>
                    <p class="text-xs sm:text-sm text-gray-500 mt-2 mb-4 text-mobile-readable leading-relaxed">جرب الأسئلة السريعة:</p>
                    
                    <!-- Quick Question Buttons -->
                    <div id="quick-questions" class="flex flex-col gap-2 mt-3">
                        <button class="quick-question-btn helal-card border border-yellow-400/30 text-yellow-400 px-4 py-2 rounded-lg text-xs sm:text-sm hover:bg-yellow-400/10 transition-all">
                            عايز حملة تسويقية
                        </button>
                        <button class="quick-question-btn helal-card border border-yellow-400/30 text-yellow-400 px-4 py-2 rounded-lg text-xs sm:text-sm hover:bg-yellow-400/10 transition-all">
                            محتاج كابشنز لبوستات
                        </button>
                        <button class="quick-question-btn helal-card border border-yellow-400/30 text-yellow-400 px-4 py-2 rounded-lg text-xs sm:text-sm hover:bg-yellow-400/10 transition-all">
                            عايز ابني براند شخصي
                        </button>
                    </div>
                </div>
            </div>
             <!-- Typing Indicator -->
            <div id="typing-indicator" class="hidden">
                 <div class="flex items-start gap-2 sm:gap-3 mb-4">
                    <div class="helal-gradient text-black p-2 sm:p-3 rounded-full flex-shrink-0 shadow-lg avatar-mobile">
                       <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sm:w-6 sm:h-6">
                           <path d="M21 15V6"/>
                           <path d="M18.5 18a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"/>
                           <path d="M12 12H3"/>
                           <path d="M16 6H3"/>
                           <path d="M12 18H3"/>
                       </svg>
                    </div>
                    <div class="helal-card p-3 sm:p-4 rounded-xl sm:rounded-2xl shadow-md flex items-center space-x-2 space-x-reverse border border-yellow-400/30 mobile-typing">
                        <div class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse [animation-delay:-0.3s]"></div>
                        <div class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse [animation-delay:-0.15s]"></div>
                        <div class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></div>
                        <span class="text-yellow-400 text-xs sm:text-sm mr-2">يكتب...</span>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Processing Overlay for PDF -->
        <div id="processing-overlay" class="hidden absolute inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-20">
            <div class="text-center text-white">
                <svg class="animate-spin h-8 w-8 text-amber-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p class="mt-2">جاري قراءة الملف...</p>
            </div>
        </div>

        <!-- Input Form -->
        <footer class="p-3 sm:p-6 border-t border-yellow-400/20 rounded-b-2xl sm:rounded-b-3xl flex-shrink-0 relative" style="background: rgba(0, 0, 0, 0.6);">
            <!-- File Preview -->
            <div id="file-preview-container" class="hidden mb-3 p-2 sm:p-3 helal-card rounded-lg sm:rounded-xl w-fit max-w-full mobile-file-preview">
                <div class="flex items-center gap-2 sm:gap-3">
                    <div id="file-icon-container" class="flex-shrink-0"></div>
                    <span id="file-name" class="text-white text-xs sm:text-sm truncate"></span>
                    <button id="remove-file-btn" type="button" class="text-gray-400 hover:text-yellow-400 transition-colors touch-target p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sm:w-5 sm:h-5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
            </div>
            <!-- Character Counter -->
            <div id="char-counter" class="hidden text-xs text-gray-400 mb-2 text-left">
                <span id="char-count">0</span> / 500 حرف
            </div>
            
            <form id="chat-form" class="flex items-center gap-2 sm:gap-4">
                <button type="button" id="upload-file-btn" class="helal-gradient text-black p-2 sm:p-3 rounded-full transition-all duration-200 hover:scale-110 shadow-lg touch-target btn-mobile">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sm:w-6 sm:h-6"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.59a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
                </button>
                <input type="file" id="file-upload-input" class="hidden" accept="image/*,application/pdf,.doc,.docx">
                <input type="text" id="message-input" placeholder="اسأل مساعد التسويق الذكي..." autocomplete="off" maxlength="500" class="flex-1 p-3 sm:p-4 border border-yellow-400/30 helal-card text-white rounded-xl sm:rounded-2xl focus:ring-2 focus:ring-yellow-400 focus:outline-none focus:border-yellow-400 transition-all duration-200 placeholder-gray-400 mobile-input text-mobile-readable" style="font-size: 16px;">
                <button type="submit" class="helal-gradient text-black p-3 sm:p-4 rounded-xl sm:rounded-2xl hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 focus:ring-offset-transparent transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center shadow-lg touch-target btn-mobile">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sm:w-6 sm:h-6"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                </button>
            </form>
        </footer>
        <div class="text-center text-xs text-yellow-400/80 px-3 sm:px-6 pb-3 sm:pb-4 rounded-b-2xl sm:rounded-b-3xl flex-shrink-0 relative" style="background: rgba(0, 0, 0, 0.6);">
            <p class="flex items-center justify-center gap-1 sm:gap-2 flex-wrap text-xs">
                <span class="font-bold text-yellow-400">Helal Content Marketing</span>
                <span>Powered by</span>
              
                <span class="hidden sm:inline">|</span>
                <span class="text-xs">Alexandria, Egypt</span>
            </p>
        </div>
    </div>

    <!-- Canvas Modal -->
    <div id="canvas-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-6xl max-h-[95vh] bg-gradient-to-br from-gray-900 to-black rounded-2xl shadow-2xl border-2 border-yellow-400/30 flex flex-col overflow-hidden">
            <!-- Canvas Header -->
            <div class="canvas-toolbar p-4 border-b border-yellow-400/30">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="helal-gradient p-2 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-black"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-yellow-400">كانفس الجداول الذكي</h2>
                            <p class="text-xs text-gray-400">أنشئ وعدل جداولك واحفظها بصيغة PDF أو CSV</p>
                        </div>
                    </div>
                    <button id="close-canvas-btn" class="text-gray-400 hover:text-yellow-400 transition-colors p-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                
                <!-- Toolbar Controls -->
                <div class="flex flex-wrap gap-2 items-center">
                    <input type="text" id="table-title" placeholder="عنوان الجدول..." class="flex-1 min-w-[200px] bg-black/50 border border-yellow-400/30 text-white px-3 py-2 rounded-lg text-sm focus:outline-none focus:border-yellow-400" value="جدول المحتوى">
                    
                    <div class="flex gap-2">
                        <button id="add-row-btn" class="bg-yellow-400/20 hover:bg-yellow-400/30 text-yellow-400 px-3 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-2 border border-yellow-400/30" title="إضافة صف">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            صف
                        </button>
                        <button id="add-col-btn" class="bg-yellow-400/20 hover:bg-yellow-400/30 text-yellow-400 px-3 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-2 border border-yellow-400/30" title="إضافة عمود">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            عمود
                        </button>
                        <button id="remove-row-btn" class="bg-red-500/20 hover:bg-red-500/30 text-red-400 px-3 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-2 border border-red-400/30" title="حذف آخر صف">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            صف
                        </button>
                        <button id="remove-col-btn" class="bg-red-500/20 hover:bg-red-500/30 text-red-400 px-3 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-2 border border-red-400/30" title="حذف آخر عمود">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            عمود
                        </button>
                    </div>
                    
                    <div class="flex gap-2">
                        <button id="download-pdf-btn" class="helal-gradient text-black px-4 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-2 hover:scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                            PDF
                        </button>
                        <button id="download-csv-btn" class="helal-gradient text-black px-4 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-2 hover:scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                            CSV
                        </button>
                        <button id="clear-canvas-btn" class="bg-gray-600/50 hover:bg-gray-600/70 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            مسح
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Canvas Content Area -->
            <div class="flex-1 overflow-auto p-6 calendar-canvas">
                <div id="canvas-table-container" class="w-full">
                    <table id="canvas-table" class="w-full border-collapse">
                        <thead>
                            <tr class="bg-yellow-400/20">
                                <th class="border border-yellow-400/30 p-3 text-yellow-400 editable-cell" contenteditable="true">التاريخ</th>
                                <th class="border border-yellow-400/30 p-3 text-yellow-400 editable-cell" contenteditable="true">الموضوع</th>
                                <th class="border border-yellow-400/30 p-3 text-yellow-400 editable-cell" contenteditable="true">التفاصيل</th>
                            </tr>
                        </thead>
                        <tbody id="canvas-tbody">
                            <tr class="calendar-cell">
                                <td class="border border-yellow-400/30 p-3 text-white editable-cell" contenteditable="true">السبت</td>
                                <td class="border border-yellow-400/30 p-3 text-white editable-cell" contenteditable="true">محتوى 1</td>
                                <td class="border border-yellow-400/30 p-3 text-white editable-cell" contenteditable="true">تفاصيل...</td>
                            </tr>
                            <tr class="calendar-cell">
                                <td class="border border-yellow-400/30 p-3 text-white editable-cell" contenteditable="true">الأحد</td>
                                <td class="border border-yellow-400/30 p-3 text-white editable-cell" contenteditable="true">محتوى 2</td>
                                <td class="border border-yellow-400/30 p-3 text-white editable-cell" contenteditable="true">تفاصيل...</td>
                            </tr>
                            <tr class="calendar-cell">
                                <td class="border border-yellow-400/30 p-3 text-white editable-cell" contenteditable="true">الإثنين</td>
                                <td class="border border-yellow-400/30 p-3 text-white editable-cell" contenteditable="true">محتوى 3</td>
                                <td class="border border-yellow-400/30 p-3 text-white editable-cell" contenteditable="true">تفاصيل...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chatForm = document.getElementById('chat-form');
            const messageInput = document.getElementById('message-input');
            const chatContainer = document.getElementById('chat-container');
            const typingIndicator = document.getElementById('typing-indicator');
            const submitButton = chatForm.querySelector('button[type="submit"]');
            const placeholder = document.getElementById('placeholder');
            const newChatBtn = document.getElementById('new-chat-btn');
            
            // Mobile viewport height fix for iOS Safari
            function setViewportHeight() {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }
            
            setViewportHeight();
            window.addEventListener('resize', setViewportHeight);
            window.addEventListener('orientationchange', () => {
                setTimeout(setViewportHeight, 100);
            });
            
            const uploadFileBtn = document.getElementById('upload-file-btn');
            const fileUploadInput = document.getElementById('file-upload-input');
            const filePreviewContainer = document.getElementById('file-preview-container');
            const fileIconContainer = document.getElementById('file-icon-container');
            const fileNameEl = document.getElementById('file-name');
            const removeFileBtn = document.getElementById('remove-file-btn');
            const processingOverlay = document.getElementById('processing-overlay');

            let uploadedFile = {
                content: null, // For base64 image or extracted PDF text
                type: null,
                name: null
            };

            // LocalStorage keys
            const STORAGE_KEYS = {
                CHAT_HISTORY: 'helal_ai_chat_history',
                MESSAGES: 'helal_ai_messages',
                LAST_UPDATED: 'helal_ai_last_updated'
            };
            
            // Load chat history from LocalStorage or use default
            let chatHistory = loadChatHistory() || [{
                role: "user",
                parts: [{ text: `You are 'Helal AI' from Helal Content Marketing agency in Alexandria, Egypt.

YOUR CORE EXPERTISE:
- Content Marketing Strategy & Execution
- Personal Branding & Brand Building
- Social Media Content Creation (captions, posts, reels)
- Digital Marketing Strategy
- Marketing Consulting

LANGUAGE RULE:
- Arabic messages → Respond in Egyptian Arabic (عامية مصرية)
- English messages → Respond in friendly professional English
- NEVER mix languages in a single response

CONVERSATION STYLE:
- Build DIALOGUE step by step - ask 1-2 questions at a time
- Keep responses SHORT and conversational
- After gathering 3-5 key details, VALIDATE before delivering
- Use Egyptian context and real local examples

VALIDATION BEFORE DELIVERY:
Before giving final strategy/content, SUMMARIZE what you gathered:
"تمام! خليني ألخص:
✓ [Detail 1]
✓ [Detail 2]
✓ [Detail 3]
صح كده؟ لو آه، هديك [الاستراتيجية/الكابشنز] دلوقتي!"

FORMATTING RESULTS (VERY IMPORTANT):
Structure ALL deliverables clearly using:

📋 **For Strategies:**
━━━━━━━━━━━━━━━━
🎯 الهدف: [goal]
👥 الجمهور: [audience]
💰 الميزانية: [budget]
━━━━━━━━━━━━━━━━

📅 **For Content Calendars & ANY Tables:**
ALWAYS use Markdown table format with pipes (|) for ANY tabular data:

| اليوم | الفكرة | الكابشن |
|------|--------|---------|
| السبت | [idea] | [caption] |
| الأحد | [idea] | [caption] |

**CRITICAL RULE**: After creating ANY table, you MUST add this EXACT line:
[📊 افتح في الكانفس للتعديل والتحميل]

This button allows users to open the table in an interactive canvas for editing and downloading as PDF/CSV.

✍️ **For Captions:**
Number them clearly:
1️⃣ [Caption 1]
   #hashtag1 #hashtag2

2️⃣ [Caption 2]
   #hashtag1 #hashtag2

EGYPTIAN CONTEXT & EXAMPLES:
- Reference Egyptian market (e.g., "زي ما شركة XYZ في مصر عملت...")
- Use Cairo/Alexandria examples when relevant
- Mention Egyptian consumer behavior
- Consider Egyptian holidays, Ramadan, summer season
- Use EGP for budgets

INDUSTRY-SPECIFIC INSIGHTS:
🍽️ **Restaurants:** Focus on food photography times, delivery apps (Talabat, Elmenus), peak hours (1-3 PM, 8-11 PM)
👗 **Fashion/Retail:** Seasonal trends, Egyptian modest fashion, weekend traffic
💼 **Services:** Trust building, testimonials, before/after
🏋️ **Fitness:** Transformation stories, summer body season, group classes appeal
🏠 **Real Estate:** Location focus (compounds, areas), payment plans, Egyptian buyer preferences

QUICK ACTIONS AFTER DELIVERY:
Always end major deliverables with follow-up options:
"إيه رأيك؟ تحب:
• نعدل حاجة معينة؟
• نعمل كابشنز لأفكار تانية؟
• نضيف استراتيجية لمنصة تانية؟
قولي وأنا جاهز! 💪"

Example Flow:
User: "عايز استراتيجية محتوى لمطعمي"
You: "تمام! 🍽️ المطعم بيقدم إيه بالظبط؟ وبتستهدف عائلات ولا شباب؟"

User: "برجر وبيتزا، شباب من 18-30"
You: "حلو أوي! وعندك فروع ولا فرع واحد؟ وإيه المنطقة؟"

User: "فرع واحد في المعمورة، الإسكندرية"
You: "ممتاز! منطقة حيوية 👍 وإيه هدفك الأساسي - زيادة الطلبات أونلاين ولا جذب عملاء للمكان؟"

User: "زيادة طلبات أونلاين"
You: "عظمة! آخر سؤال: إيه الميزانية الشهرية للإعلانات؟ وعايز كام بوست في الأسبوع؟"

User: "5000 جنيه، 4-5 بوستات"
You: "تمام! خليني ألخص:
✓ مطعم برجر وبيتزا
✓ شباب 18-30 سنة
✓ المعمورة، إسكندرية
✓ هدف: زيادة الطلبات أونلاين
✓ ميزانية: 5000 ج/شهر
✓ 4-5 بوستات/أسبوع

صح كده؟ لو آه، هديك استراتيجية محتوى كاملة دلوقتي!"

[Then deliver formatted strategy with Egyptian context]

IMPORTANT NOTES:
- You create CAPTIONS/COPY, you DON'T analyze images
- Use emojis naturally for visual organization
- Keep language conversational and helpful
- Show you understand Egyptian market nuances

Your goal: Be a knowledgeable Egyptian marketing consultant who delivers REAL, ACTIONABLE content.` }]
            }, {
                role: "model",
                parts: [{ text: "أهلاً! 😊 أنا Helal AI من وكالة هلال بالإسكندرية.\n\nمتخصص في التسويق بالمحتوى والبراند الشخصي.\n\nمحتاج مساعدة في إيه؟ 🚀" }]
            }];

            // LocalStorage functions
            function saveChatHistory() {
                try {
                    localStorage.setItem(STORAGE_KEYS.CHAT_HISTORY, JSON.stringify(chatHistory));
                    localStorage.setItem(STORAGE_KEYS.LAST_UPDATED, Date.now().toString());
                } catch (e) {
                    console.error('Failed to save chat history:', e);
                }
            }
            
            function loadChatHistory() {
                try {
                    const saved = localStorage.getItem(STORAGE_KEYS.CHAT_HISTORY);
                    if (saved) {
                        return JSON.parse(saved);
                    }
                } catch (e) {
                    console.error('Failed to load chat history:', e);
                }
                return null;
            }
            
            function saveMessages(messages) {
                try {
                    localStorage.setItem(STORAGE_KEYS.MESSAGES, JSON.stringify(messages));
                } catch (e) {
                    console.error('Failed to save messages:', e);
                }
            }
            
            function loadMessages() {
                try {
                    const saved = localStorage.getItem(STORAGE_KEYS.MESSAGES);
                    if (saved) {
                        return JSON.parse(saved);
                    }
                } catch (e) {
                    console.error('Failed to load messages:', e);
                }
                return [];
            }
            
            function clearAllData() {
                try {
                    localStorage.removeItem(STORAGE_KEYS.CHAT_HISTORY);
                    localStorage.removeItem(STORAGE_KEYS.MESSAGES);
                    localStorage.removeItem(STORAGE_KEYS.LAST_UPDATED);
                } catch (e) {
                    console.error('Failed to clear data:', e);
                }
            }
            
            function scrollToBottom() {
                // Smooth scroll to bottom of chat container
                chatContainer.scrollTo({
                    top: chatContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }
            
            // Restore previous messages from LocalStorage
            function restorePreviousMessages() {
                const messages = loadMessages();
                if (messages.length > 0) {
                    placeholder.style.display = 'none';
                    messages.forEach(msg => {
                        if (msg.sender === 'bot') {
                            displayBotMessageInstant(msg.text);
                        } else {
                            displayMessage(msg.sender, msg.text, msg.file);
                        }
                    });
                    setTimeout(scrollToBottom, 100);
                }
            }

            function displayMessage(sender, message, fileInfo = null) {
                if (placeholder) placeholder.style.display = 'none';
                let messageContent = ``;
                if (message) {
                    messageContent += `<p class="text-white">${message.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>`;
                }

                if (fileInfo && fileInfo.name) {
                    if (fileInfo.type.startsWith('image/')) {
                        messageContent = `<img src="data:${fileInfo.type};base64,${fileInfo.content}" class="rounded-lg max-w-full h-auto" alt="Uploaded Image">${message ? `<p class="mt-2 text-white">${message}</p>` : ''}`;
                    } else {
                        messageContent += `<div class="mt-2 p-2 bg-gray-600 rounded-lg text-sm text-gray-300 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                            <span>تم إرفاق ملف: ${fileInfo.name}</span>
                        </div>`;
                    }
                }
                let messageHtml = '';
                if (sender === 'user') {
                    messageHtml = `
                        <div class="flex items-start gap-2 sm:gap-3 mb-4 sm:mb-6 justify-end">
                            <div class="helal-card border border-yellow-400/30 text-white p-3 sm:p-4 rounded-xl sm:rounded-2xl shadow-lg mobile-message backdrop-blur-sm text-mobile-readable">${messageContent}</div>
                            <div class="bg-yellow-400/20 text-yellow-400 p-2 sm:p-3 rounded-full flex-shrink-0 border border-yellow-400/40 avatar-mobile">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sm:w-5 sm:h-5">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                    <circle cx="12" cy="7" r="4"/>
                                </svg>
                            </div>
                        </div>`;
                } else { // bot
                    messageHtml = `
                        <div class="flex items-start gap-2 sm:gap-3 mb-4 sm:mb-6">
                            <div class="helal-gradient text-black p-2 sm:p-3 rounded-full flex-shrink-0 shadow-lg avatar-mobile">
                               <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sm:w-6 sm:h-6">
                                   <path d="M21 15V6"/>
                                   <path d="M18.5 18a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"/>
                                   <path d="M12 12H3"/>
                                   <path d="M16 6H3"/>
                                   <path d="M12 18H3"/>
                               </svg>
                            </div>
                            <div class="helal-card border border-yellow-400/20 p-3 sm:p-4 rounded-xl sm:rounded-2xl shadow-lg mobile-message backdrop-blur-sm">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-yellow-400 text-xs font-semibold">Helal AI</span>
                                </div>
                                <p class="text-white leading-relaxed text-mobile-readable">${message}</p>
                            </div>
                        </div>`;
                }
                // FIX: Insert the new message BEFORE the typing indicator element
                typingIndicator.insertAdjacentHTML('beforebegin', messageHtml);
                
                // Add bottom padding to last message for better scroll experience
                const lastMessage = typingIndicator.previousElementSibling;
                if (lastMessage) {
                    lastMessage.style.marginBottom = '2rem';
                }
                
                setTimeout(scrollToBottom, 100);
            }
            
            // Streaming bot message (typewriter effect)
            let botMessageIdCounter = 0;
            let currentMessages = loadMessages(); // Track messages for saving
            
            function displayBotMessageStreaming(message) {
                if (placeholder) placeholder.style.display = 'none';
                const messageId = `bot-msg-${Date.now()}-${++botMessageIdCounter}`;
                const messageHtml = `
                    <div class="flex items-start gap-2 sm:gap-3 mb-4 sm:mb-6 message-container">
                        <div class="helal-gradient text-black p-2 sm:p-3 rounded-full flex-shrink-0 shadow-lg avatar-mobile">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sm:w-6 sm:h-6">
                               <path d="M21 15V6"/>
                               <path d="M18.5 18a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"/>
                               <path d="M12 12H3"/>
                               <path d="M16 6H3"/>
                               <path d="M12 18H3"/>
                           </svg>
                        </div>
                        <div class="flex-1">
                            <div class="helal-card border border-yellow-400/20 p-3 sm:p-4 rounded-xl sm:rounded-2xl shadow-lg mobile-message backdrop-blur-sm">
                                <div class="flex items-center justify-between gap-2 mb-2">
                                    <span class="text-yellow-400 text-xs font-semibold">Helal AI</span>
                                    <div class="flex gap-1">
                                        <button onclick="copyMessage('${messageId}')" class="copy-btn text-gray-400 hover:text-yellow-400 transition-colors p-1 rounded" title="نسخ">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                        </button>
                                        <button onclick="shareMessage('${messageId}')" class="share-btn text-gray-400 hover:text-yellow-400 transition-colors p-1 rounded" title="مشاركة">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                                        </button>
                                    </div>
                                </div>
                                <p id="${messageId}" class="text-white leading-relaxed text-mobile-readable"></p>
                            </div>
                        </div>
                    </div>`;
                typingIndicator.insertAdjacentHTML('beforebegin', messageHtml);
                const contentEl = document.getElementById(messageId);
                typeOutText(contentEl, message);
                
                // Save bot message to storage
                currentMessages.push({ sender: 'bot', text: message });
                saveMessages(currentMessages);
                
                const lastMessage = typingIndicator.previousElementSibling;
                if (lastMessage) lastMessage.style.marginBottom = '2rem';
                setTimeout(scrollToBottom, 50);
            }
            
            // Display bot message instantly (for restoring from storage)
            function displayBotMessageInstant(message) {
                if (placeholder) placeholder.style.display = 'none';
                const messageId = `bot-msg-${Date.now()}-${++botMessageIdCounter}`;
                const messageHtml = `
                    <div class="flex items-start gap-2 sm:gap-3 mb-4 sm:mb-6 message-container">
                        <div class="helal-gradient text-black p-2 sm:p-3 rounded-full flex-shrink-0 shadow-lg avatar-mobile">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sm:w-6 sm:h-6">
                               <path d="M21 15V6"/>
                               <path d="M18.5 18a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"/>
                               <path d="M12 12H3"/>
                               <path d="M16 6H3"/>
                               <path d="M12 18H3"/>
                           </svg>
                        </div>
                        <div class="flex-1">
                            <div class="helal-card border border-yellow-400/20 p-3 sm:p-4 rounded-xl sm:rounded-2xl shadow-lg mobile-message backdrop-blur-sm">
                                <div class="flex items-center justify-between gap-2 mb-2">
                                    <span class="text-yellow-400 text-xs font-semibold">Helal AI</span>
                                    <div class="flex gap-1">
                                        <button onclick="copyMessage('${messageId}')" class="copy-btn text-gray-400 hover:text-yellow-400 transition-colors p-1 rounded" title="نسخ">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                        </button>
                                        <button onclick="shareMessage('${messageId}')" class="share-btn text-gray-400 hover:text-yellow-400 transition-colors p-1 rounded" title="مشاركة">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                                        </button>
                                    </div>
                                </div>
                                <p id="${messageId}" class="text-white leading-relaxed text-mobile-readable">${message.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, '<br>')}</p>
                            </div>
                        </div>
                    </div>`;
                typingIndicator.insertAdjacentHTML('beforebegin', messageHtml);
                
                // Parse markdown tables for instant messages too
                const instantElement = document.getElementById(messageId);
                if (instantElement) {
                    parseMarkdownTables(instantElement);
                }
            }

            function typeOutText(element, text, speed = 12) {
                const safeText = (str) => str
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/\n/g, '<br>');
                let index = 0;
                let tableDetected = false;
                
                function step() {
                    if (index >= text.length) {
                        // Final parse after typing is complete
                        parseMarkdownTables(element);
                        scrollToBottom();
                        return;
                    }
                    const nextChunk = text.slice(index, index + 2);
                    element.innerHTML += safeText(nextChunk);
                    index += 2;
                    
                    // Detect if we're in a table section
                    const currentText = text.slice(0, index);
                    const lines = currentText.split('\n');
                    const currentLine = lines[lines.length - 1];
                    
                    // Check if current line has table pattern and we completed a row
                    if (currentLine.includes('|') && currentLine.trim().endsWith('|')) {
                        tableDetected = true;
                    }
                    
                    // If we detected a table and completed a row, or if we're at the end
                    if (tableDetected && (!currentLine.includes('|') || index >= text.length)) {
                        parseMarkdownTables(element);
                        tableDetected = false;
                    }
                    
                    if (index % 30 === 0) scrollToBottom();
                    setTimeout(step, speed);
                }
                
                step();
            }
            
            // Parse Markdown tables and convert canvas button text
            function parseMarkdownTables(element) {
                // Don't re-parse if already has a table element
                if (element.querySelector('.markdown-table')) {
                    // Just update the button if needed
                    let html = element.innerHTML;
                    if (!html.includes('onclick="openCanvasFromTable')) {
                        html = html.replace(/\[📊 افتح في الكانفس للتعديل والتحميل\]/g, 
                            '<button onclick="openCanvasFromTable(this)" class="mt-3 helal-gradient text-black px-4 py-2 rounded-lg text-sm font-semibold transition-all inline-flex items-center gap-2 hover:scale-105"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>📊 افتح في الكانفس للتعديل والتحميل</button>');
                        element.innerHTML = html;
                    }
                    return;
                }
                
                let html = element.innerHTML;
                
                // Convert markdown tables to HTML tables - match complete tables only
                // This regex ensures we have header, separator, and at least one row
                const tableRegex = /\|(.+?)\|<br>\|[\-:\s|]+\|<br>((?:\|.+?\|<br>)+)/g;
                
                html = html.replace(tableRegex, (match, headers, rows) => {
                    try {
                        // Parse headers
                        const headerCells = headers.split('|').map(h => h.trim()).filter(h => h);
                        if (headerCells.length === 0) return match; // Return original if parsing fails
                        
                        const headerHtml = headerCells.map(h => `<th class="border border-yellow-400/50 bg-yellow-400/10 px-3 py-2 text-yellow-400">${h}</th>`).join('');
                        
                        // Parse rows - handle both <br> and end of string
                        const rowLines = rows.trim().split('<br>').filter(r => r.trim() && r.includes('|'));
                        if (rowLines.length === 0) return match; // Return original if no valid rows
                        
                        const rowsHtml = rowLines.map(row => {
                            const cells = row.split('|').map(c => c.trim()).filter(c => c);
                            // Ensure row has same number of cells as headers
                            while (cells.length < headerCells.length) cells.push('');
                            const cellsHtml = cells.slice(0, headerCells.length).map(c => `<td class="border border-yellow-400/30 px-3 py-2 text-white">${c}</td>`).join('');
                            return `<tr>${cellsHtml}</tr>`;
                        }).join('');
                        
                        return `<div class="my-4 overflow-x-auto table-parsed"><table class="w-full border-collapse table-auto markdown-table" style="background: rgba(0,0,0,0.3); border-radius: 8px; overflow: hidden;"><thead><tr>${headerHtml}</tr></thead><tbody>${rowsHtml}</tbody></table></div>`;
                    } catch (e) {
                        console.error('Error parsing table:', e);
                        return match; // Return original text if parsing fails
                    }
                });
                
                // Convert [📊 افتح في الكانفس للتعديل والتحميل] to actual button after all table processing
                html = html.replace(/\[📊 افتح في الكانفس للتعديل والتحميل\]/g, 
                    '<button onclick="openCanvasFromTable(this)" class="mt-3 helal-gradient text-black px-4 py-2 rounded-lg text-sm font-semibold transition-all inline-flex items-center gap-2 hover:scale-105"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>📊 افتح في الكانفس للتعديل والتحميل</button>');
                
                element.innerHTML = html;
            }

            // Remove Markdown asterisks and underscores from bot responses
            function sanitizeMarkdown(text) {
                if (!text) return text;
                return text
                    .replace(/\*\*(.*?)\*\*/g, '$1')   // **bold** → bold
                    .replace(/__(.*?)__/g, '$1')          // __bold__ → bold
                    .replace(/\*(.*?)\*/g, '$1')        // *italic* or *list* → italic/list text only
                    .replace(/_(.*?)_/g, '$1');           // _italic_ → italic
            }
            
            async function getBotResponse(prompt, file = null) {
                let userParts = [];
                let fullPrompt = prompt;

                // Detect if user is writing in English or Arabic
                const isEnglish = /^[a-zA-Z0-9\s\.,!?;:()\-'"@#$%&*\/]+$/.test(prompt.trim());
                
                if (file && file.type.startsWith('image/')) {
                    // For images, we write captions/copy, not analyze the image
                    const imagePrompt = isEnglish
                        ? `The user sent an image and asked: "${prompt}"\n\nYou're a content marketing expert who creates CAPTIONS and COPY for social media posts. Based on their request, provide ready-to-use captions, hashtags, or content strategy in friendly professional English. You don't analyze the image itself - you create the TEXT/COPY that goes with it.`
                        : `المستخدم بعت صورة وسأل: "${prompt}"\n\nانت متخصص في كتابة الكابشنز والمحتوى التسويقي. بناءً على طلبه، اديله كابشنز جاهزة للاستخدام، هاشتاجات، أو استراتيجية محتوى بالعامية المصرية. انت مش بتحلل الصورة - انت بتكتب النص/الكابشن اللي يمشي معاها.`;
                    userParts.push({ text: imagePrompt });
                    userParts.push({ inlineData: { mimeType: file.type, data: file.content } });
                } else if (file && file.type === 'application/pdf') {
                    if (file.content === 'PDF_PARSING_ERROR') {
                        fullPrompt = isEnglish 
                            ? `The user tried to upload a PDF file named "${file.name}" but there was a technical error reading it. Respond in friendly professional English, apologize for the issue, suggest trying another file or sharing content differently. Ask them about what they need help with in marketing.`
                            : `المستخدم حاول يرفع ملف PDF اسمه "${file.name}" بس حصل مشكلة تقنية في قراءة الملف. رد عليه بالعامية المصرية بشكل ودود واعتذر عن المشكلة، واقترح عليه يجرب ملف تاني أو يبعت المحتوى بطريقة تانية. واسأله عن تفاصيل أكتر عن اللي محتاج مساعدة فيه في التسويق.`;
                    } else if (file.content === 'PDF_IS_IMAGE') {
                        fullPrompt = isEnglish
                            ? `The user uploaded a PDF file named "${file.name}" but it contains only images without readable text. Respond in friendly professional English, apologize, tell them they can send images separately or share text content, and ask what marketing help they need.`
                            : `المستخدم رفع ملف PDF اسمه "${file.name}" لكن الملف ده فيه صور بس من غير نصوص أقدر أقراها. رد عليه بالعامية المصرية بشكل ودود واعتذر، وقوله إنه يقدر يبعت الصور منفصلة أو يكتب المحتوى نص، واسأله عن إيه اللي محتاج مساعدة فيه في التسويق.`;
                    } else if (file.content) {
                        const truncatedContent = file.content.substring(0, 15000);
                        fullPrompt = isEnglish
                            ? `The user sent a PDF file named "${file.name}" with marketing/business content. Here's the content:\n\n---\n${truncatedContent}\n---\n\nAnalyze this content from a marketing perspective and respond to the user's question in friendly professional English in a conversational way. Ask questions to understand their needs better. Their question: "${prompt}"`
                            : `المستخدم بعت ملف PDF اسمه "${file.name}" فيه محتوى تسويقي/تجاري، وده المحتوى:\n\n---\n${truncatedContent}\n---\n\nحلل المحتوى ده من منظور تسويقي، ورد على سؤال المستخدم بالعامية المصرية بشكل تفاعلي واسأله أسئلة عشان تفهم احتياجاته أكتر. سؤاله: "${prompt}"`;
                    }
                     userParts.push({ text: fullPrompt });
                } else if (file) {
                    fullPrompt = isEnglish
                        ? `The user sent a file named "${file.name}" of type ${file.type}. Respond in friendly professional English, tell them you specialize in analyzing marketing content, images, and PDFs. Suggest they send images, PDF files, or ask direct marketing questions. Their question: "${prompt}"`
                        : `المستخدم بعت ملف اسمه "${file.name}" من نوع ${file.type}. رد عليه بالعامية المصرية بشكل ودود وقوله إنك متخصص في تحليل المحتوى التسويقي والصور وملفات PDF، واقترح عليه يبعت صور أو ملفات PDF أو يسأل أسئلة تسويقية مباشرة. سؤاله: "${prompt}"`;
                    userParts.push({ text: fullPrompt });
                } else {
                    userParts.push({ text: prompt });
                }

                chatHistory.push({ role: "user", parts: userParts });
                saveChatHistory(); // Save after adding user message
                
                const apiKey = "AIzaSyDVk30nhdS-gMsMne1ywNTELmllkBTPKCA"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: chatHistory };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                        let botResponseText = result.candidates[0].content.parts[0].text;
                        botResponseText = sanitizeMarkdown(botResponseText);
                        chatHistory.push({ role: "model", parts: [{ text: botResponseText }] });
                        saveChatHistory(); // Save after bot response
                        return botResponseText;
                    }
                    // Detect language for error messages
                    const isEnglish = /^[a-zA-Z0-9\s\.,!?;:()\-'"@#$%&*\/]+$/.test(prompt.trim());
                    return isEnglish 
                        ? "Sorry, a small technical issue occurred. Please try again or rephrase your question, and I'm here to help! 😊"
                        : "آسف، حصلت مشكلة تقنية بسيطة دلوقتي. جرب تاني أو اسألني السؤال بطريقة تانية وأنا هنا عشان أساعدك! 😊";
                } catch (error) {
                    console.error("Error fetching bot response:", error);
                    // Detect language for error messages
                    const isEnglish = /^[a-zA-Z0-9\s\.,!?;:()\-'"@#$%&*\/]+$/.test(prompt.trim());
                    return isEnglish
                        ? "Sorry, a small technical issue happened. Our technical team is working on it. Can you try again in a bit? 🙏"
                        : "عذراً يا فندم، في مشكلة تقنية صغيرة حصلت. الفريق التقني بتاعنا شغال على حلها. ممكن تجرب تاني بعد شوية؟ 🙏";
                }
            }
            
            uploadFileBtn.addEventListener('click', () => {
                fileUploadInput.click();
            });
            
            fileUploadInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                uploadedFile.name = file.name;
                uploadedFile.type = file.type;
                fileNameEl.textContent = file.name;

                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        uploadedFile.content = e.target.result.split(',')[1];
                        fileIconContainer.innerHTML = `<img src="${e.target.result}" class="h-12 w-12 object-cover rounded" />`;
                        filePreviewContainer.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                } else if (file.type === 'application/pdf') {
                    processingOverlay.classList.remove('hidden');
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const pdf = await pdfjsLib.getDocument(e.target.result).promise;
                            let fullText = '';
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                const pageText = textContent.items.map(item => item.str).join(' ');
                                fullText += pageText + '\n\n';
                            }
                            
                            if (!fullText.trim()) {
                                uploadedFile.content = 'PDF_IS_IMAGE';
                            } else {
                                uploadedFile.content = fullText.trim();
                            }
                            fileIconContainer.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>`;
                            filePreviewContainer.classList.remove('hidden');
                        } catch (error) {
                            console.error('Error parsing PDF:', error);
                            uploadedFile.content = 'PDF_PARSING_ERROR';
                            fileIconContainer.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-red-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="12" x2="12" y2="18" /><line x1="12" y1="12" x2="12" y2="18" /></svg>`;
                            filePreviewContainer.classList.remove('hidden');
                        } finally {
                            processingOverlay.classList.add('hidden');
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    uploadedFile.content = null; // We don't process other files
                    fileIconContainer.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>`;
                    filePreviewContainer.classList.remove('hidden');
                }
            });

            removeFileBtn.addEventListener('click', () => {
                uploadedFile = { content: null, type: null, name: null };
                fileUploadInput.value = '';
                filePreviewContainer.classList.add('hidden');
            });

            // Character counter
            const charCounter = document.getElementById('char-counter');
            const charCount = document.getElementById('char-count');
            
            messageInput.addEventListener('input', () => {
                const length = messageInput.value.length;
                charCount.textContent = length;
                
                if (length > 0) {
                    charCounter.classList.remove('hidden');
                } else {
                    charCounter.classList.add('hidden');
                }
                
                // Change color when approaching limit
                if (length > 450) {
                    charCount.classList.add('text-yellow-400');
                } else {
                    charCount.classList.remove('text-yellow-400');
                }
            });
            
            // Quick question buttons
            const quickQuestions = document.querySelectorAll('.quick-question-btn');
            quickQuestions.forEach(btn => {
                btn.addEventListener('click', () => {
                    messageInput.value = btn.textContent.trim();
                    messageInput.focus();
                    chatForm.dispatchEvent(new Event('submit'));
                });
            });
            
            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const message = messageInput.value.trim();
                if (!message && !uploadedFile.name) return;

                // Disable form immediately
                submitButton.disabled = true;
                messageInput.disabled = true;
                
                // Hide keyboard on mobile after submit
                messageInput.blur();
                
                // Display user message and clear inputs
                displayMessage('user', message, uploadedFile.name ? uploadedFile : null);
                
                // Save user message
                currentMessages.push({ sender: 'user', text: message, file: uploadedFile.name ? uploadedFile : null });
                saveMessages(currentMessages);
                
                messageInput.value = '';
                charCounter.classList.add('hidden');
                
                // Scroll to show user message
                setTimeout(scrollToBottom, 50);
                
                // Show typing indicator
                typingIndicator.classList.remove('hidden');
                setTimeout(scrollToBottom, 100);

                // Get bot response
                const botResponse = await getBotResponse(message, uploadedFile.name ? uploadedFile : null);
                
                // Clear file after it has been sent
                removeFileBtn.click(); 

                // Hide typing indicator and display response
                typingIndicator.classList.add('hidden');
                displayBotMessageStreaming(botResponse);
                
                // Re-enable form
                submitButton.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            });
            
            // New chat button - Clear everything and start fresh
            newChatBtn.addEventListener('click', () => {
                if (confirm('هل تريد بدء محادثة جديدة؟ سيتم مسح المحادثة الحالية.')) {
                    // Clear UI
                    const messages = chatContainer.querySelectorAll('.message-container, .flex.items-start');
                    messages.forEach(msg => {
                        if (!msg.id || msg.id !== 'placeholder' && msg.id !== 'typing-indicator') {
                            msg.remove();
                        }
                    });
                    
                    // Clear storage
                    clearAllData();
                    
                    // Reset chat history to default
                    chatHistory = [{
                        role: "user",
                        parts: [{ text: `You are 'Helal AI' from Helal Content Marketing agency in Alexandria, Egypt.

YOUR CORE EXPERTISE:
- Content Marketing Strategy & Execution
- Personal Branding & Brand Building
- Social Media Content Creation (captions, posts, reels)
- Digital Marketing Strategy
- Marketing Consulting

LANGUAGE RULE:
- Arabic messages → Respond in Egyptian Arabic (عامية مصرية)
- English messages → Respond in friendly professional English
- NEVER mix languages in a single response

CONVERSATION STYLE:
- Build DIALOGUE step by step - ask 1-2 questions at a time
- Keep responses SHORT and conversational
- After gathering 3-5 key details, VALIDATE before delivering
- Use Egyptian context and real local examples

VALIDATION BEFORE DELIVERY:
Before giving final strategy/content, SUMMARIZE what you gathered:
"تمام! خليني ألخص:
✓ [Detail 1]
✓ [Detail 2]
✓ [Detail 3]
صح كده؟ لو آه، هديك [الاستراتيجية/الكابشنز] دلوقتي!"

FORMATTING RESULTS (VERY IMPORTANT):
Structure ALL deliverables clearly using:

📋 **For Strategies:**
━━━━━━━━━━━━━━━━
🎯 الهدف: [goal]
👥 الجمهور: [audience]
💰 الميزانية: [budget]
━━━━━━━━━━━━━━━━

📅 **For Content Calendars & ANY Tables:**
ALWAYS use Markdown table format with pipes (|) for ANY tabular data:

| اليوم | الفكرة | الكابشن |
|------|--------|---------|
| السبت | [idea] | [caption] |
| الأحد | [idea] | [caption] |

**CRITICAL RULE**: After creating ANY table, you MUST add this EXACT line:
[📊 افتح في الكانفس للتعديل والتحميل]

This button allows users to open the table in an interactive canvas for editing and downloading as PDF/CSV.

✍️ **For Captions:**
Number them clearly:
1️⃣ [Caption 1]
   #hashtag1 #hashtag2

2️⃣ [Caption 2]
   #hashtag1 #hashtag2

EGYPTIAN CONTEXT & EXAMPLES:
- Reference Egyptian market (e.g., "زي ما شركة XYZ في مصر عملت...")
- Use Cairo/Alexandria examples when relevant
- Mention Egyptian consumer behavior
- Consider Egyptian holidays, Ramadan, summer season
- Use EGP for budgets

INDUSTRY-SPECIFIC INSIGHTS:
🍽️ **Restaurants:** Focus on food photography times, delivery apps (Talabat, Elmenus), peak hours (1-3 PM, 8-11 PM)
👗 **Fashion/Retail:** Seasonal trends, Egyptian modest fashion, weekend traffic
💼 **Services:** Trust building, testimonials, before/after
🏋️ **Fitness:** Transformation stories, summer body season, group classes appeal
🏠 **Real Estate:** Location focus (compounds, areas), payment plans, Egyptian buyer preferences

QUICK ACTIONS AFTER DELIVERY:
Always end major deliverables with follow-up options:
"إيه رأيك؟ تحب:
• نعدل حاجة معينة؟
• نعمل كابشنز لأفكار تانية؟
• نضيف استراتيجية لمنصة تانية؟
قولي وأنا جاهز! 💪"

Example Flow:
User: "عايز استراتيجية محتوى لمطعمي"
You: "تمام! 🍽️ المطعم بيقدم إيه بالظبط؟ وبتستهدف عائلات ولا شباب؟"

User: "برجر وبيتزا، شباب من 18-30"
You: "حلو أوي! وعندك فروع ولا فرع واحد؟ وإيه المنطقة؟"

User: "فرع واحد في المعمورة، الإسكندرية"
You: "ممتاز! منطقة حيوية 👍 وإيه هدفك الأساسي - زيادة الطلبات أونلاين ولا جذب عملاء للمكان؟"

User: "زيادة طلبات أونلاين"
You: "عظمة! آخر سؤال: إيه الميزانية الشهرية للإعلانات؟ وعايز كام بوست في الأسبوع؟"

User: "5000 جنيه، 4-5 بوستات"
You: "تمام! خليني ألخص:
✓ مطعم برجر وبيتزا
✓ شباب 18-30 سنة
✓ المعمورة، إسكندرية
✓ هدف: زيادة الطلبات أونلاين
✓ ميزانية: 5000 ج/شهر
✓ 4-5 بوستات/أسبوع

صح كده؟ لو آه، هديك استراتيجية محتوى كاملة دلوقتي!"

[Then deliver formatted strategy with Egyptian context]

IMPORTANT NOTES:
- You create CAPTIONS/COPY, you DON'T analyze images
- Use emojis naturally for visual organization
- Keep language conversational and helpful
- Show you understand Egyptian market nuances

Your goal: Be a knowledgeable Egyptian marketing consultant who delivers REAL, ACTIONABLE content.` }]
                    }, {
                        role: "model",
                        parts: [{ text: "أهلاً! 😊 أنا Helal AI من وكالة هلال بالإسكندرية.\n\nمتخصص في التسويق بالمحتوى والبراند الشخصي.\n\nمحتاج مساعدة في إيه؟ 🚀" }]
                    }];
                    
                    currentMessages = [];
                    saveChatHistory();
                    saveMessages(currentMessages);
                    
                    // Show placeholder
                    placeholder.style.display = 'flex';
                    
                    // Reset quick questions visibility
                    const quickQuestionsDiv = document.getElementById('quick-questions');
                    if (quickQuestionsDiv) {
                        quickQuestionsDiv.style.display = 'flex';
                    }
                }
            });
            
            // Restore previous messages on page load
            restorePreviousMessages();
            
            // ==================== CANVAS FUNCTIONALITY ====================
            const canvasBtn = document.getElementById('canvas-btn');
            const canvasModal = document.getElementById('canvas-modal');
            const closeCanvasBtn = document.getElementById('close-canvas-btn');
            const canvasTable = document.getElementById('canvas-table');
            const canvasTbody = document.getElementById('canvas-tbody');
            const addRowBtn = document.getElementById('add-row-btn');
            const addColBtn = document.getElementById('add-col-btn');
            const removeRowBtn = document.getElementById('remove-row-btn');
            const removeColBtn = document.getElementById('remove-col-btn');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            const downloadCsvBtn = document.getElementById('download-csv-btn');
            const clearCanvasBtn = document.getElementById('clear-canvas-btn');
            const tableTitle = document.getElementById('table-title');
            
            // Open Canvas Modal
            canvasBtn.addEventListener('click', () => {
                canvasModal.classList.remove('hidden');
                loadCanvasData();
            });
            
            // Close Canvas Modal
            closeCanvasBtn.addEventListener('click', () => {
                canvasModal.classList.add('hidden');
                saveCanvasData();
            });
            
            // Close on outside click
            canvasModal.addEventListener('click', (e) => {
                if (e.target === canvasModal) {
                    canvasModal.classList.add('hidden');
                    saveCanvasData();
                }
            });
            
            // Add Row
            addRowBtn.addEventListener('click', () => {
                const colCount = canvasTable.querySelector('thead tr').children.length;
                const newRow = document.createElement('tr');
                newRow.className = 'calendar-cell';
                
                for (let i = 0; i < colCount; i++) {
                    const td = document.createElement('td');
                    td.className = 'border border-yellow-400/30 p-3 text-white editable-cell';
                    td.contentEditable = 'true';
                    td.textContent = 'نص جديد...';
                    newRow.appendChild(td);
                }
                
                canvasTbody.appendChild(newRow);
                saveCanvasData();
            });
            
            // Add Column
            addColBtn.addEventListener('click', () => {
                // Add header cell
                const thead = canvasTable.querySelector('thead tr');
                const th = document.createElement('th');
                th.className = 'border border-yellow-400/30 p-3 text-yellow-400 editable-cell';
                th.contentEditable = 'true';
                th.textContent = 'عمود جديد';
                thead.appendChild(th);
                
                // Add cell to each row
                const rows = canvasTbody.querySelectorAll('tr');
                rows.forEach(row => {
                    const td = document.createElement('td');
                    td.className = 'border border-yellow-400/30 p-3 text-white editable-cell';
                    td.contentEditable = 'true';
                    td.textContent = 'نص جديد...';
                    row.appendChild(td);
                });
                
                saveCanvasData();
            });
            
            // Remove Row
            removeRowBtn.addEventListener('click', () => {
                const rows = canvasTbody.querySelectorAll('tr');
                if (rows.length > 1) {
                    rows[rows.length - 1].remove();
                    saveCanvasData();
                } else {
                    alert('لا يمكن حذف آخر صف!');
                }
            });
            
            // Remove Column
            removeColBtn.addEventListener('click', () => {
                const thead = canvasTable.querySelector('thead tr');
                const colCount = thead.children.length;
                
                if (colCount > 1) {
                    // Remove last header cell
                    thead.removeChild(thead.lastChild);
                    
                    // Remove last cell from each row
                    const rows = canvasTbody.querySelectorAll('tr');
                    rows.forEach(row => {
                        row.removeChild(row.lastChild);
                    });
                    
                    saveCanvasData();
                } else {
                    alert('لا يمكن حذف آخر عمود!');
                }
            });
            
            // Clear Canvas
            clearCanvasBtn.addEventListener('click', () => {
                if (confirm('هل تريد مسح كل البيانات في الجدول؟')) {
                    // Reset to default
                    canvasTable.querySelector('thead tr').innerHTML = `
                        <th class="border border-yellow-400/30 p-3 text-yellow-400 editable-cell" contenteditable="true">التاريخ</th>
                        <th class="border border-yellow-400/30 p-3 text-yellow-400 editable-cell" contenteditable="true">الموضوع</th>
                        <th class="border border-yellow-400/30 p-3 text-yellow-400 editable-cell" contenteditable="true">التفاصيل</th>
                    `;
                    
                    canvasTbody.innerHTML = `
                        <tr class="calendar-cell">
                            <td class="border border-yellow-400/30 p-3 text-white editable-cell" contenteditable="true">السبت</td>
                            <td class="border border-yellow-400/30 p-3 text-white editable-cell" contenteditable="true">محتوى 1</td>
                            <td class="border border-yellow-400/30 p-3 text-white editable-cell" contenteditable="true">تفاصيل...</td>
                        </tr>
                        <tr class="calendar-cell">
                            <td class="border border-yellow-400/30 p-3 text-white editable-cell" contenteditable="true">الأحد</td>
                            <td class="border border-yellow-400/30 p-3 text-white editable-cell" contenteditable="true">محتوى 2</td>
                            <td class="border border-yellow-400/30 p-3 text-white editable-cell" contenteditable="true">تفاصيل...</td>
                        </tr>
                        <tr class="calendar-cell">
                            <td class="border border-yellow-400/30 p-3 text-white editable-cell" contenteditable="true">الإثنين</td>
                            <td class="border border-yellow-400/30 p-3 text-white editable-cell" contenteditable="true">محتوى 3</td>
                            <td class="border border-yellow-400/30 p-3 text-white editable-cell" contenteditable="true">تفاصيل...</td>
                        </tr>
                    `;
                    
                    tableTitle.value = 'جدول المحتوى';
                    saveCanvasData();
                }
            });
            
            // Save canvas data to localStorage
            function saveCanvasData() {
                const data = {
                    title: tableTitle.value,
                    headers: [],
                    rows: []
                };
                
                // Save headers
                const headers = canvasTable.querySelectorAll('thead th');
                headers.forEach(th => {
                    data.headers.push(th.textContent);
                });
                
                // Save rows
                const rows = canvasTbody.querySelectorAll('tr');
                rows.forEach(row => {
                    const rowData = [];
                    const cells = row.querySelectorAll('td');
                    cells.forEach(cell => {
                        rowData.push(cell.textContent);
                    });
                    data.rows.push(rowData);
                });
                
                localStorage.setItem('helal_canvas_data', JSON.stringify(data));
            }
            
            // Load canvas data from localStorage
            function loadCanvasData() {
                const saved = localStorage.getItem('helal_canvas_data');
                if (!saved) return;
                
                try {
                    const data = JSON.parse(saved);
                    
                    // Set title
                    tableTitle.value = data.title || 'جدول المحتوى';
                    
                    // Set headers
                    if (data.headers && data.headers.length > 0) {
                        const thead = canvasTable.querySelector('thead tr');
                        thead.innerHTML = '';
                        data.headers.forEach(headerText => {
                            const th = document.createElement('th');
                            th.className = 'border border-yellow-400/30 p-3 text-yellow-400 editable-cell';
                            th.contentEditable = 'true';
                            th.textContent = headerText;
                            thead.appendChild(th);
                        });
                    }
                    
                    // Set rows
                    if (data.rows && data.rows.length > 0) {
                        canvasTbody.innerHTML = '';
                        data.rows.forEach(rowData => {
                            const tr = document.createElement('tr');
                            tr.className = 'calendar-cell';
                            rowData.forEach(cellText => {
                                const td = document.createElement('td');
                                td.className = 'border border-yellow-400/30 p-3 text-white editable-cell';
                                td.contentEditable = 'true';
                                td.textContent = cellText;
                                tr.appendChild(td);
                            });
                            canvasTbody.appendChild(tr);
                        });
                    }
                } catch (e) {
                    console.error('Error loading canvas data:', e);
                }
            }
            
            // Auto-save on content change
            canvasTable.addEventListener('input', () => {
                saveCanvasData();
            });
            
            tableTitle.addEventListener('input', () => {
                saveCanvasData();
            });
            
            // Download as CSV
            downloadCsvBtn.addEventListener('click', () => {
                const title = tableTitle.value || 'جدول';
                let csv = '\uFEFF'; // UTF-8 BOM for Excel Arabic support
                
                // Add headers
                const headers = canvasTable.querySelectorAll('thead th');
                const headerTexts = Array.from(headers).map(th => `"${th.textContent.trim()}"`);
                csv += headerTexts.join(',') + '\n';
                
                // Add rows
                const rows = canvasTbody.querySelectorAll('tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const cellTexts = Array.from(cells).map(td => `"${td.textContent.trim()}"`);
                    csv += cellTexts.join(',') + '\n';
                });
                
                // Download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${title}.csv`;
                link.click();
            });
            
            // Download as PDF
            downloadPdfBtn.addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                // Add Arabic font support (using default font but RTL)
                const title = tableTitle.value || 'جدول المحتوى';
                
                // Title
                doc.setFontSize(18);
                doc.text(title, 105, 20, { align: 'center' });
                
                // Prepare table data
                const headers = [];
                const thead = canvasTable.querySelectorAll('thead th');
                thead.forEach(th => {
                    headers.push(th.textContent.trim());
                });
                
                const rows = [];
                const tbody = canvasTbody.querySelectorAll('tr');
                tbody.forEach(tr => {
                    const row = [];
                    const cells = tr.querySelectorAll('td');
                    cells.forEach(td => {
                        row.push(td.textContent.trim());
                    });
                    rows.push(row);
                });
                
                // Draw table manually
                let yPosition = 35;
                const cellWidth = 190 / headers.length;
                const cellHeight = 10;
                const startX = 10;
                
                // Draw headers
                doc.setFillColor(255, 215, 0);
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(12);
                
                headers.forEach((header, i) => {
                    doc.rect(startX + (i * cellWidth), yPosition, cellWidth, cellHeight, 'F');
                    doc.text(header, startX + (i * cellWidth) + cellWidth/2, yPosition + 7, { align: 'center' });
                });
                
                yPosition += cellHeight;
                
                // Draw rows
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                
                rows.forEach((row, rowIndex) => {
                    row.forEach((cell, cellIndex) => {
                        // Alternate row colors
                        if (rowIndex % 2 === 0) {
                            doc.setFillColor(245, 245, 245);
                            doc.rect(startX + (cellIndex * cellWidth), yPosition, cellWidth, cellHeight, 'F');
                        }
                        
                        doc.rect(startX + (cellIndex * cellWidth), yPosition, cellWidth, cellHeight, 'S');
                        doc.text(cell, startX + (cellIndex * cellWidth) + cellWidth/2, yPosition + 7, { align: 'center' });
                    });
                    
                    yPosition += cellHeight;
                    
                    // New page if needed
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                    }
                });
                
                // Add footer
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text('Generated by Helal AI - Content Calendar', 105, 285, { align: 'center' });
                
                // Save
                doc.save(`${title}.pdf`);
            });
        });
        
        // Open canvas from table button
        function openCanvasFromTable(button) {
            // Find the table before this button
            let element = button.previousElementSibling;
            let table = null;
            
            // Search backwards for the table
            while (element && !table) {
                if (element.tagName === 'DIV' && element.querySelector('table.markdown-table')) {
                    table = element.querySelector('table.markdown-table');
                    break;
                } else if (element.tagName === 'TABLE' && element.classList.contains('markdown-table')) {
                    table = element;
                    break;
                }
                element = element.previousElementSibling;
            }
            
            // If not found, search in the parent element
            if (!table) {
                let parent = button.parentElement;
                while (parent && !table) {
                    table = parent.querySelector('table.markdown-table');
                    if (!table) {
                        parent = parent.previousElementSibling;
                    }
                }
            }
            
            if (!table) {
                alert('لم يتم العثور على الجدول!');
                console.log('Button element:', button);
                console.log('Parent element:', button.parentElement);
                return;
            }
            
            // Extract table data
            const canvasTable = document.getElementById('canvas-table');
            const canvasTbody = document.getElementById('canvas-tbody');
            const tableTitle = document.getElementById('table-title');
            
            // Clear current canvas table
            canvasTable.querySelector('thead tr').innerHTML = '';
            canvasTbody.innerHTML = '';
            
            // Set title (try to find a heading before the table)
            let titleElement = button.parentElement;
            while (titleElement && titleElement.tagName !== 'H1' && titleElement.tagName !== 'H2' && titleElement.tagName !== 'H3') {
                titleElement = titleElement.previousElementSibling;
            }
            tableTitle.value = titleElement ? titleElement.textContent.trim() : 'جدول من المحادثة';
            
            // Copy headers
            const sourceHeaders = table.querySelectorAll('thead th');
            const thead = canvasTable.querySelector('thead tr');
            sourceHeaders.forEach(th => {
                const newTh = document.createElement('th');
                newTh.className = 'border border-yellow-400/30 p-3 text-yellow-400 editable-cell';
                newTh.contentEditable = 'true';
                newTh.textContent = th.textContent.trim();
                thead.appendChild(newTh);
            });
            
            // Copy rows
            const sourceRows = table.querySelectorAll('tbody tr');
            sourceRows.forEach(tr => {
                const newRow = document.createElement('tr');
                newRow.className = 'calendar-cell';
                
                const sourceCells = tr.querySelectorAll('td');
                sourceCells.forEach(td => {
                    const newTd = document.createElement('td');
                    newTd.className = 'border border-yellow-400/30 p-3 text-white editable-cell';
                    newTd.contentEditable = 'true';
                    newTd.textContent = td.textContent.trim();
                    newRow.appendChild(newTd);
                });
                
                canvasTbody.appendChild(newRow);
            });
            
            // Save to localStorage
            const saveEvent = new Event('input', { bubbles: true });
            canvasTable.dispatchEvent(saveEvent);
            
            // Open canvas modal
            document.getElementById('canvas-modal').classList.remove('hidden');
        }
        
        // Copy message function
        function copyMessage(messageId) {
            const messageElement = document.getElementById(messageId);
            const text = messageElement.innerText || messageElement.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                // Show temporary success message
                const btn = event.target.closest('button');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                btn.classList.add('text-green-400');
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('text-green-400');
                }, 1500);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('فشل النسخ. حاول مرة أخرى.');
            });
        }
        
        // Share message function
        function shareMessage(messageId) {
            const messageElement = document.getElementById(messageId);
            const text = messageElement.innerText || messageElement.textContent;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Helal AI',
                    text: text,
                    url: window.location.href
                }).catch(err => {
                    console.log('Share cancelled or failed:', err);
                });
            } else {
                // Fallback: Copy to clipboard
                copyMessage(messageId);
            }
        }
    </script>
</body>
</html>
